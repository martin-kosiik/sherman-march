---
title: "Code"
author: "Martin Kos√≠k"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(mapview)
library(USAboundaries)
library(broom)
```

```{r}
sherman_march_map <- st_read(here::here("maps/sherman_march/sherman_march_shapefile.shp"))

#plot(sherman_march_map)
counties  <- us_counties(states = c("Georgia", "North Carolina", "South Carolina")) %>% 
  mutate(fips = as.numeric(paste0(statefp, countyfp)))

counties_1860  <- us_counties(states = c("1866-09-17", "Georgia", "North Carolina", "South Carolina")) %>% 
  mutate(fips = as.numeric(paste0(statefp, countyfp)))

conf_mon <- read_csv(here::here("data/conf_monuments.csv")) %>% 
  separate(Coordinates, into = c("lon", "lat"), sep = ", ", remove = FALSE, convert = TRUE) %>% 
  mutate(lon = as.numeric(lon), 
         lat = as.numeric(lat)) %>% 
  filter(!is.na(lon)) %>% 
  st_as_sf(coords = c("lat","lon"), crs = 4326) # %>% st_set_crs("+proj=longlat +datum=WGS84 +no_defs")

#mapview(conf_mon)

mon_by_county <- counties %>% 
  st_join(conf_mon) %>% 
  st_set_geometry(NULL) %>% 
  group_by(fips) %>% 
  summarize(monuments = sum(!is.na(feature_name))) 
  
```

```{r}
march_buffer_10km <- sherman_march_map %>% 
  st_transform(crs = 7801) %>% 
  st_buffer(dist = 10000, nQuadSegs = 1) 


march_buffer_5miles <- sherman_march_map %>% 
  st_transform(crs = 7801) %>% 
  st_buffer(dist = 8046.72, nQuadSegs = 1) 


#mapview(counties)
```

```{r}
march_counties <- counties %>% 
  st_transform(crs = 7801) %>% 
  st_intersection(march_buffer_5miles) %>% 
  st_set_geometry(NULL) %>% 
  distinct(fips) %>% #count(fips, sort = T)
  dplyr::select(fips) %>% 
  mutate(march = 1)
```


```{r}
counties <- counties %>% 
  left_join(march_counties, by = "fips") %>% 
  left_join(mon_by_county, by = "fips") %>% 
  mutate(march = ifelse(is.na(march), 0, march), 
         monuments_dummy = ifelse(monuments == 0, 0, 1))

counties %>% 
  ggplot(aes(fill = as.factor(march))) +
    geom_sf(color = "gray50", size = 0.5) +
    geom_sf(data = st_transform(sherman_march_map, crs = "+proj=longlat +datum=WGS84 +no_defs"), fill = "black", size = 1)+
    theme_void() +
    coord_sf(crs = "+proj=longlat +datum=WGS84 +no_defs", ndiscr = F) + 
    labs(fill = "Sherman's March") + 
    theme(legend.position="bottom")


```


```{r warning=FALSE, message=FALSE}
county_data <- read_csv("data/acharya_et_al_2016_county_data.csv")

county_data <- county_data %>% 
  right_join(counties, by = c("fips"))

#county_data <- county_data %>% 
#  full_join(counties, by = c("fips")) %>% 
#  mutate(march = ifelse(is.na(march), 0, march))
```

```{r}
county_data %>% 
  ggplot(aes(fill = pslave1860)) +
    geom_sf(color = "gray50", size = 0.5) +
    geom_sf(data = st_transform(sherman_march_map, crs = "+proj=longlat +datum=WGS84 +no_defs"), fill = "black", size = 2)+
    theme_void() +
    coord_sf(crs = "+proj=longlat +datum=WGS84 +no_defs", ndiscr = F) + 
    labs(fill = "Proportion of slaves in 1860") +
    scale_fill_gradient(low = "white", high = "red")

```

```{r}
county_data %>% 
  ggplot(aes(fill = pdem1900)) +
    geom_sf(color = "gray50", size = 0.5) +
    geom_sf(data = st_transform(sherman_march_map, crs = "+proj=longlat +datum=WGS84 +no_defs"), fill = "black", size = 2)+
    theme_void() +
    coord_sf(crs = "+proj=longlat +datum=WGS84 +no_defs", ndiscr = F) + 
    labs(fill = "Proportion of vote for Democrats  in 1900") +
    scale_fill_gradient(low = "white", high = "red") +
   theme(legend.position="bottom")


```



```{r}

lm(lynchrate ~ march + pslave1860, data = county_data) %>% 
  summary()


fit_model <- function(dep_var, controls = ""){
 lm(as.formula(paste0(dep_var, " ~ march", controls)), data = county_data) %>% 
  tidy(conf.int = TRUE)
}


pdem <- paste0("pdem", seq(from = 1868, to = 1964, by = 4))



pdem_march_coefs <- map(pdem, fit_model) %>% 
  set_names(pdem) %>% 
  map2(pdem, ~ mutate(.x, year = .y)) %>% 
  bind_rows() %>% 
  filter(term == "march") %>% 
  mutate(year = as.numeric(str_sub(year, start = -4)))

```


```{r}
pdem_march_coefs %>% 
  ggplot(aes(x = year, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() + 
  theme_bw()
```


```{r}
pdem_march_coefs_slave_control <- map(pdem, ~ fit_model(dep_var = ., controls = "+ pslave1860")) %>% 
  set_names(pdem) %>% 
  map2(pdem, ~ mutate(.x, year = .y)) %>% 
  bind_rows() %>% 
  filter(term == "march") %>% 
  mutate(year = as.numeric(str_sub(year, start = -4)))

```

```{r}
pdem_march_coefs_slave_control %>% 
  ggplot(aes(x = year, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() + 
  theme_bw() + geom_hline(yintercept = 0, col = "black")

```


```{r}
lm(monuments_dummy ~ march + pslave1860, data = county_data) %>% 
  summary()

#lm(monuments ~ march + pslave1860, data = county_data) %>% 
#  summary()

```


```{osm }
/*
This shows the cycleway and cycleroute network.
*/

[out:csv(
   ::"id", ::"lat", highway, name, "tiger:name_base" , "tiger:zip_right", "tiger:zip_left" )];

(
  // get cycle route relatoins
  // get cycleways
  way[highway=primary]({{bbox}});
  way[highway=secondary]({{bbox}});
  way[highway=tertiaty]({{bbox}});
  way[highway=unclassified]({{bbox}});
  way[highway=residential]({{bbox}});
);

out center;

```


```{r}
streets <- read_delim("data/southern_streets.txt", 
    "\t", escape_double = FALSE, col_names = c("id", "lat", "lon", "type", "st_name", "name"), 
    trim_ws = TRUE, skip = 1)

streets <- streets %>% 
  filter(!is.na(st_name)) %>% 
  mutate(st_name_clean = str_remove_all(st_name, "Drive|Avenue|Street|Trail|Lane|Way|Road|Highway|Place|Court"),
         st_name_clean = str_trim(st_name_clean), 
         confederate = ifelse(st_name_clean %in% c("Lee", "Davis", "Forrest", "Jackson", "Stonewall"), 1, 0),
         union = ifelse(st_name_clean %in% c("Lincoln", "Grant", "Sherman"), 1, 0))

```

```{r}
streets %>% 
  count(confederate)
```
0.2736633 % of streets
```{r}
streets %>% 
  count(union)

```

